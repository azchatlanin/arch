---
- name: "Playing with Ansible and Git"
  hosts: all
  connection: local
  become: "yes"

  tasks:
  ## Partitions disk
  - name: "Partitions disk"
    block:
      - name: Create boot partition
        parted:
          device: '{{ install_drive }}'
          label: gpt
          number: 1
          part_end: 512MB
          name: boot
          flags: [boot, esp]
          state: present
          part_type: primary
      - name: Create root partition
        parted:
          device: '{{ install_drive }}'
          label: gpt
          number: 2
          part_start: 512MB
          part_end: 22GB
          name: root
          state: present
          part_type: primary
      - name: Create swap partition
        parted:
          device: '{{ install_drive }}'
          label: gpt
          number: 3
          part_start: 22GB
          part_end: 25GB
          name: swap
          state: present
          part_type: primary

  ## Create filesystems
  - name: Create filesystems
    block:
      - name: Create FAT32 filesystem in boot partition
        filesystem:
          dev: '{{ install_drive }}1'
          fstype: vfat
          opts: -F32
          force: yes
      - name: Create ext4 filesystem in root volume
        filesystem:
          dev: '{{ install_drive }}2'
          fstype: ext4
          force: yes
      - name: Create filesystem in swap volume
        filesystem:
          dev: '{{ install_drive }}3'
          fstype: swap
          force: yes

  ## Mount filesystems
  - name: Mount filesystems
    block:
      # root
      - name: Mount root filesystem
        mount:
          path: /mnt
          src: '{{ install_drive }}2'
          fstype: ext4
          state: mounted
      # mountpoint
      - name: Create mountpoint for {boot} volume
        file:
          path: /mnt/boot
          state: directory
        file:
          path: /mnt/boot/efi
          state: directory
      # boot
      - name: Mount boot filesystem
        mount:
          path: /mnt/boot/efi
          src: '{{ install_drive }}1'
          fstype: vfat
          state: mounted
      # swap
      - name: Mount swap filesystem
        command: 'swapon {{ install_drive }}3'

  ## Pacstrap
  - name: Run pacstrap
    command: pacstrap /mnt base base-devel linux-lts linux-firmware ansible git bash-completion networkmanager wireless_tools modemmanager mobile-broadband-provider-info usb_modeswitch rp-pppoe network-manager-applet net-tools wpa_supplicant dialog neovim curl wget tar alacritty grub efibootmgr

  - name: Generate blank fstab
    command: genfstab -U /mnt >> /mnt/etc/fstab

  - name: Get arch-chroot
    command: arch-chroot /mnt